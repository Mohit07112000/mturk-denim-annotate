<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Denim Line Annotation Task</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    h2 { color: #d33; }
    #denim-img { 
      max-width: 90%; 
      border: 2px solid #ddd; 
      border-radius: 8px; 
      display: block; 
      margin: 10px 0; 
    }
    #status { font-weight: 500; margin: 8px 0; }
    #submitBtn { 
      padding: 8px 16px; 
      background: #007bff; 
      color: #fff; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
    }
    #submitBtn[disabled] { background: #aaa; cursor: not-allowed; }
    .canvas-container { position: relative; display: inline-block; }
    #lineCanvas { position: absolute; left: 0; top: 0; cursor: crosshair; }
  </style>
</head>
<body>
  <h2>ðŸ§µ Denim Line Annotation Task</h2>
  <p>
    Please draw <b>two straight lines</b> in order:
    <ol>
      <li><b>First line</b> â†’ along the <b>waistband seam</b></li>
      <li><b>Second line</b> â†’ along the <b>Post-it edge</b></li>
    </ol>
    Once both are drawn, click <b>Submit</b>.
  </p>
  <div id="status">0/2 lines drawn</div>

  <div class="canvas-container">
    <img id="denim-img" />
    <canvas id="lineCanvas"></canvas>
  </div>

  <form method="POST" id="mturk_form">
    <input type="hidden" name="assignmentId" id="assignmentId" />
    <input type="hidden" name="waist_x1" id="waist_x1" />
    <input type="hidden" name="waist_y1" id="waist_y1" />
    <input type="hidden" name="waist_x2" id="waist_x2" />
    <input type="hidden" name="waist_y2" id="waist_y2" />
    <input type="hidden" name="postit_x1" id="postit_x1" />
    <input type="hidden" name="postit_y1" id="postit_y1" />
    <input type="hidden" name="postit_x2" id="postit_x2" />
    <input type="hidden" name="postit_y2" id="postit_y2" />
    <br><br>
    <input type="submit" id="submitBtn" value="Submit" disabled />
  </form>

  <script>
    const params = new URLSearchParams(window.location.search);
    const imageUrl = params.get("image");
    const assignmentId = params.get("assignmentId");
    const img = document.getElementById("denim-img");
    const form = document.getElementById("mturk_form");
    const submitBtn = document.getElementById("submitBtn");
    const status = document.getElementById("status");
    const canvas = document.getElementById("lineCanvas");
    const ctx = canvas.getContext("2d");

    img.src = imageUrl || "https://placehold.co/600x400?text=Denim+Image";
    document.getElementById("assignmentId").value = assignmentId || "";

    const isSandbox = window.location.href.includes("workersandbox");
    form.action = isSandbox
      ? "https://workersandbox.mturk.com/mturk/externalSubmit"
      : "https://www.mturk.com/mturk/externalSubmit";

    if (assignmentId === "ASSIGNMENT_ID_NOT_AVAILABLE" || !assignmentId) {
      submitBtn.disabled = true;
      submitBtn.value = "Accept the HIT first";
    }

    img.onload = () => {
      canvas.width = img.clientWidth;
      canvas.height = img.clientHeight;

      let lines = [];
      let startPoint = null;

      canvas.addEventListener("mousedown", (e) => {
        if (lines.length >= 2) {
          alert("You can only draw two lines â€” waistband and Post-it.");
          return;
        }
        const rect = canvas.getBoundingClientRect();
        startPoint = { x: e.clientX - rect.left, y: e.clientY - rect.top };
      });

      canvas.addEventListener("mouseup", (e) => {
        if (!startPoint) return;
        const rect = canvas.getBoundingClientRect();
        const endPoint = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        lines.push({ start: startPoint, end: endPoint });
        startPoint = null;
        drawLines();
        updateStatus();
      });

      function drawLines() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 3;
        ctx.strokeStyle = "#ff6600";

        lines.forEach((l, i) => {
          ctx.beginPath();
          ctx.moveTo(l.start.x, l.start.y);
          ctx.lineTo(l.end.x, l.end.y);
          ctx.stroke();

          // Label each line visually
          ctx.fillStyle = "#000";
          ctx.font = "14px sans-serif";
          const label = i === 0 ? "Waistband" : "Post-it";
          ctx.fillText(label, l.end.x + 5, l.end.y);
        });
      }

      function updateStatus() {
        if (lines.length === 0) {
          status.textContent = "0/2 lines drawn";
        } else if (lines.length === 1) {
          status.textContent = "âœ… Waistband line done (1/2)";
        } else if (lines.length === 2) {
          status.textContent = "âœ… Both lines done! Ready to submit.";
          submitBtn.disabled = false;
        }
      }

      form.addEventListener("submit", (e) => {
        if (lines.length !== 2) {
          alert("Please draw both lines before submitting!");
          // e.preventDefault();
          return;
        }

        const [waist, postit] = lines;

        document.getElementById("waist_x1").value = waist.start.x;
        document.getElementById("waist_y1").value = waist.start.y;
        document.getElementById("waist_x2").value = waist.end.x;
        document.getElementById("waist_y2").value = waist.end.y;

        document.getElementById("postit_x1").value = postit.start.x;
        document.getElementById("postit_y1").value = postit.start.y;
        document.getElementById("postit_x2").value = postit.end.x;
        document.getElementById("postit_y2").value = postit.end.y;

        console.log("Submitting Coordinates:", {
          assignmentId,
          waistband: waist,
          postit
        });

        // For testing only â€” comment this out when going live
        // e.preventDefault();
      });
    };
  </script>
</body>
</html>
