<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Denim Annotation Task</title>
  <script src="https://cdn.jsdelivr.net/npm/@recogito/annotorious@2.7.12/dist/annotorious.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@recogito/annotorious@2.7.12/dist/annotorious.min.css" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    h2 { display: flex; align-items: center; gap: 4px; color: #d33; }
    #denim-img { 
      max-width: 90%; 
      border: 2px solid #ddd; 
      border-radius: 8px; 
      display: block; 
      margin: 10px 0; 
      position: relative; 
    }
    #status { font-weight: 500; margin: 8px 0; }
    #submitBtn { 
      padding: 8px 16px; 
      background: #007bff; 
      color: #fff; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
    }
    #submitBtn[disabled] { background: #aaa; cursor: not-allowed; }
  </style>
</head>
<body>
  <h2>ðŸ§µ Denim Annotation Task</h2>
  <p>Draw <b>two boxes</b> â€” one around the waistband seam, and one around the Post-it. Then click <b>Submit</b>.</p>
  <div id="status">0/2 boxes drawn</div>

  <img id="denim-img" />

  <form method="POST" id="mturk_form">
    <input type="hidden" name="assignmentId" id="assignmentId" />
    <input type="hidden" name="x1" id="x1" />
    <input type="hidden" name="y1" id="y1" />
    <input type="hidden" name="w1" id="w1" />
    <input type="hidden" name="h1" id="h1" />
    <input type="hidden" name="x2" id="x2" />
    <input type="hidden" name="y2" id="y2" />
    <input type="hidden" name="w2" id="w2" />
    <input type="hidden" name="h2" id="h2" />
    <br /><br />
    <input type="submit" id="submitBtn" value="Submit" disabled />
  </form>
  <script>
    const params = new URLSearchParams(window.location.search);
    const imageUrl = params.get("image");
    const assignmentId = params.get("assignmentId");
    const img = document.getElementById("denim-img");
    const form = document.getElementById("mturk_form");
    const submitBtn = document.getElementById("submitBtn");
    const status = document.getElementById("status");

    img.src = imageUrl || "https://placehold.co/600x400?text=Denim+Image";
    document.getElementById("assignmentId").value = assignmentId || "";

    const isSandbox = window.location.href.includes("workersandbox");
    form.action = isSandbox
      ? "https://workersandbox.mturk.com/mturk/externalSubmit"
      : "https://www.mturk.com/mturk/externalSubmit";

    if (assignmentId === "ASSIGNMENT_ID_NOT_AVAILABLE" || !assignmentId) {
      submitBtn.disabled = true;
      submitBtn.value = "Accept the HIT first";
    }

    img.onload = () => {
      // âœ¨ --- THIS IS THE CHANGE --- âœ¨
      const anno = Annotorious.init({ 
        image: 'denim-img',
        disableEditor: true ,
        allowEmpty: true  // This disables the comment/tag popup
      });
      // --- End of change ---

      let annotations = []; // This array will store our coordinate objects

      // This event now fires *immediately* after the user finishes drawing
      anno.on('createAnnotation', (annotation) => {
        console.log('createAnnotation triggered', annotation);
        
        const [x, y, w, h] = annotation.target.selector.value
          .replace('xywh=pixel:', '')
          .split(',')
          .map(Number);

        annotations.push({ id: annotation.id, x, y, w, h });

        if (annotations.length > 2) {
          anno.removeAnnotation(annotation.id);
          annotations.pop();
          alert("Only 2 boxes allowed!");
          return;
        }

        status.textContent = `${annotations.length}/2 boxes drawn`;
        if (annotations.length === 2) {
          status.textContent = "âœ… All boxes done! Ready to submit.";
          submitBtn.disabled = false;
        }
      });

      // Handles moves or resizes
      anno.on('updateAnnotation', (annotation, previous) => {
        console.log('updateAnnotation triggered', annotation.id);
        
        const index = annotations.findIndex(a => a.id === previous.id);
        if (index > -1) {
          const [x, y, w, h] = annotation.target.selector.value
            .replace('xywh=pixel:', '')
            .split(',')
            .map(Number);
            
          annotations[index] = { id: annotation.id, x, y, w, h };
          console.log('Updated coordinates in array:', annotations[index]);
        }
      });

      // Handles deletions
      anno.on('deleteAnnotation', (annotation) => {
        console.log('deleteAnnotation triggered', annotation.id);
        
        annotations = annotations.filter(a => a.id !== annotation.id);
        
        status.textContent = `${annotations.length}/2 boxes drawn`;
        submitBtn.disabled = true;
      });

      // Handles form submission
      form.addEventListener('submit', (e) => {
        // For local testing only
        e.preventDefault(); 
        
        if (annotations.length !== 2) {
          alert("Please draw exactly 2 boxes before submitting!");
          return;
        }

        const [first, second] = annotations;
        x1.value = first.x; y1.value = first.y; w1.value = first.w; h1.value = first.h;
        x2.value = second.x; y2.value = second.y; w2.value = second.w; h2.value = second.h;

        console.log("Submitting:", Object.fromEntries(new FormData(form)));
        
        // Remember to remove e.preventDefault() for real MTurk submission
      });
    };
  </script>
</body>
</html>
